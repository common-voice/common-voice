# Setting up a local development environment

[Fork](https://help.github.com/articles/fork-a-repo/) and [clone](https://help.github.com/articles/cloning-a-repository/) the repository onto your computer. You can either run the project using a Docker(#docker) container or by setting it up manually(#manual-installation).

The project is organized into the following directories:

- _common_: Features that are shared between the frontend and backend of Common Voice, such as Typescript types.
- _locales_: Information about activated languages on the site, automatically generated by [yarn import-locales](#updating-languages)
- _maintenance_: Static code for maintenance mode on Common Voice
- _scripts_: Some scripts for managing data
- _server_: The server-side app logic, written in [TypeScript](http://www.typescriptlang.org/).
- _web_: The Common Voice website files, written in [TypeScript](http://www.typescriptlang.org/). We use [React](https://reactjs.org/) to build the website.

## Docker

We provide a [docker-compose](https://docs.docker.com/compose/) setup to orchestrate the local development environment configuration using [Docker](https://www.docker.com/). This is our recommended way of setting up your local development environment, as it will bypass the need to install each component separately.

### Requirements

- [Docker](https://www.docker.com/)
- [docker-compose](https://docs.docker.com/compose/)

### Configuration

You can find configurable options, like the port Common Voice is running on, in `/server/src/config-helper.ts`. If you want to modify any of these values, you will need to create a configuration file.

If you're using Docker, you should save this file as `.env-local-docker` in the root directory of the project, and it will be formatted like unix env values, with each key having a `CV_` prefix. For example:

```
CV_DB_ROOT_PASS="root"
CV_MYSQLHOST="db"
CV_IMPORT_SENTENCES="true"
```

### Setup steps

Run the following commands:

```
> cd common-voice
> docker-compose up
```

This is going to:

- Launch a mysql instance configured for `common-voice`
- Launch an s3proxy instance to store files locally and avoid going through setting up AWS S3.
- Mount the project using a Docker volume to allow reflecting changes to the codebase directly to the container.
- Launch `common-voice` server

You can visit the website at [http://localhost:9000](http://localhost:9000).

**Note**: Docker can be a very memory-intensive process. If you notice intermittent failures, or if features like auto-rebuilding crash, try increasing Docker's available memory from within Docker's _Preferences > Resources_ settings.\*\*

### Troubleshooting

If you get an error like the following when running native Docker (not Docker for Desktop),

```
ERROR: Couldn't connect to Docker daemon at http+docker://localhost - is it running?
```

You may need to build a new image. You can do that by issuing the following commands:

```
> cd docker/
> docker build .
```

Then after this you can:

```
> cd ..
> docker-compose up
```

You may have to run these commands as root/superuser.

---

## Manual installation

You may want to set up each component manually. In which case you will need:

### Requirements

- [NodeJS](https://nodejs.org) (v10.7+)
- [yarn](https://yarnpkg.com) (v1 or higher)
- [MySQL](https://www.mysql.com/downloads/) (v5.7 or higher)

### Configuration

You can find configurable options, like the port Common Voice is running on, in `/server/src/config-helper.ts`. If you want to modify any of these values, you will need to create a configuration file.

If you installed the app manually, create a `/config.json` with the config you want to override in JSON format. The keys will not have a `CV_` prefix. For example:

```
{
  "IMPORT_SENTENCES": false
  "MYSQLDBNAME": "voice",
  "MYSQLHOST": "127.0.0.1",
}
```

### Database preparation

Once the required components are installed, you need to prepare your database.

You can either create a MySQL superuser that that uses the default `DB_ROOT_USER` and `DB_ROOT_PASS` values from `/server/src/config-helper.ts` or create your own config as described above.

### S3 configuration

The Common Voice project uses S3 for voice clip storage. This will be provided for you if you use the Docker installation, but if you are doing local development you will need to set up your own S3 instance. For detaield instructions on how to do that, see [HOWTO_S3.md](./HOWTO_S3.md)

### Setup steps

Make sure your MySQL server is running. Then run the following commands:

```
> yarn
> yarn start
```

This will:

1. Install all JavaScript dependencies.
2. Build and serve files located in the `web` folder on localhost.
3. Save uploaded voice clips onto Amazon's S3.
4. Lint and rebuild all js files on every change.

You can then access the website at [http://localhost:9000](http://localhost:9000).

### Troubleshooting

#### MySQL errors during startup

During the **first** server start (after running ‘yarn start’), you might notice an error log similar to this:

```
at Class.exports.up (/Users/admin/Desktop/myprojects/mozilla/common-voice-master/server/src/lib/model/db/migrations/20180910121256-user-sso-fields.ts:2:13)
....
[BE]       at /Users/admin/Desktop/myprojects/mozilla/common-voice-master/node_modules/db-migrate/lib/migrator.js:237:31 {
[BE]     code: 'ER_BLOB_CANT_HAVE_DEFAULT',
[BE]     errno: 1101,
[BE]     sqlMessage: "BLOB, TEXT, GEOMETRY or JSON column 'username' can't have a default value",
[BE]     sqlState: '42000',
[BE]     index: 0,
[BE]     sql: '\n' +
[BE]       '      ALTER TABLE user_clients\n' +
[BE]       '        ADD COLUMN sso_id VARCHAR(255) UNIQUE,\n' +
[BE]       "        ADD COLUMN username TEXT NOT NULL DEFAULT '',\n" +
[BE]       '        ADD COLUMN basket_token TEXT;\n' +
[BE]       '    '
```

1. In the error log, locate and open the associated migrations file (located in the `/migrations` directory). In this case, the file is named `20180910121256-user-sso-fields.ts`.
1. Locate the affected column declaration - revealed by the “sqlMessage” string in the error log - and remove the default declaration value i.e In our case, the column username will have a new declaration `ADD COLUMN username TEXT NOT NULL` instead of `ADD COLUMN username TEXT NOT NULL DEFAULT ‘ ’`
1. Fixing one migration error will uncover another error in another migration file. Repeat the same process until there are no more migration errors.
1. Discard all changes made to the relevant migration files.

## Authentication

If you want to work with login-related features (Profile, Dashboard, Goals, ...) you'll need to set up authentication:

1. Create an [Auth0](https://auth0.com/) account.
2. Click "Applications" from the dashboard. Create a new one, or use the default application.
3. Go to "Applications" and click on the Settings icon next to your application.
4. Add `http://localhost:9000/callback` to the "Allowed Callback URLs" list.
5. If you're using Docker, copy the following keys from the Auth0 application into your configuration file. These are found in the same Settings tab as the "Allowed Callback URLs".

Docker:

```env
CV_AUTH0_DOMAIN="<domain_here>"
CV_AUTH0_CLIENT_ID="<client_id_here>"
CV_AUTH0_CLIENT_SECRET="<client_secret_here>"
```

Local development:

```json
"AUTH0": {
 "DOMAIN": "<domain_here>",
 "CLIENT_ID": "<client_id_here>",
 "CLIENT_SECRET": "<client_secret_here>"
}
```

6. You can add more login options to your app from the "Connections" tab
7. Restart your local Common Voice instance
8. You will now be able to create a new user by clicking on "Log in" on your Common Voice instance and then switching over to the "Sign Up" tab on the login dialog.

## Database migrations

We use [db-migrate](https://github.com/db-migrate/node-db-migrate) for running database migrations.

To add a migration run:
`yarn migrate create <MIGRATION_NAME>`.

At the moment you manually have to change the migration file extension to `.ts`. A migration has to expose the following API:

```typescript
export const up = async function (db: any): Promise<any> {
  return null;
};

export const down = async function (): Promise<any> {
  return null;
};
```

Migrations are always run when the server is started.

## Localization

We're using [Fluent](http://projectfluent.org/) to localize strings. You can find examples all over the frontend code. Strings that appear in the [english message files](https://github.com/mozilla/common-voice/tree/main/web/locales/en), can then be translated on [Pontoon](https://pontoon.mozilla.org/projects/common-voice/). Some things to note regarding string changes are documented on [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Localization/Localization_content_best_practices#Changing_existing_strings).

## Updating languages

To update the list of locales run:

```
> yarn import-locales
```

This creates/updates files in `/locales`:

- fetch locale codes & names from Pontoon and save them in `all.json`
- based on Pontoon translated data and a threshold defined in the script, save "completed" locales to `translated.json`
- add codes that have a sentence folder in `/server/data` and at least 5k sentences to `contributable.json`

## Submitting an Issue

Did you notice a bug? Do you have a feature request? Please file an issue [here on GitHub](https://github.com/mozilla/common-voice/issues).

## Something Else?

Want to talk about something but can't find a home for it here? Head to our [Discourse Category](https://discourse.mozilla-community.org/c/voice) to discuss everything from feedback and ideas to questions and random musings.
