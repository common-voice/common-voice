# Setting up a local development environment

## Contents 

- [Setting up a local development environment](#setting-up-a-local-development-environment)
  - [Contents](#contents)
  - [Who this guide is for](#who-this-guide-is-for)
  - [Prerequistes](#prerequistes)
  - [Summary to get up and running](#summary-to-get-up-and-running)
  - [Forking and cloning the `common-voice` repository](#forking-and-cloning-the-common-voice-repository)
  - [Project organization](#project-organization)
  - [Orchestrating the environment with `docker` and `docker-compose`](#orchestrating-the-environment-with-docker-and-docker-compose)
    - [`.env-local-docker` file](#env-local-docker-file)
    - [Running the application through `docker`](#running-the-application-through-docker)
      - [Flushing the `redis` cache](#flushing-the-redis-cache)
    - [Minimal setup](#minimal-setup)
  - [Troubleshooting](#troubleshooting)
    - [Couldn't connect to Docker daemon](#couldnt-connect-to-docker-daemon)
    - [Running `docker-compose up` results in incorrect file system permissions on `/code/node_modules` directory](#running-docker-compose-up-results-in-incorrect-file-system-permissions-on-codenode_modules-directory)
  - [Linting Typescript code contributions](#linting-typescript-code-contributions)
  - [Authentication](#authentication)
  - [Database migrations](#database-migrations)
  - [Localization](#localization)
  - [Updating languages](#updating-languages)
  - [Testing using Jest](#testing-using-jest)
  - [Submitting an Issue](#submitting-an-issue)
  - [Something Else?](#something-else)

## Who this guide is for

This guide is intended for: 

* Developers who would like to work on patching bugs or adding new features to the `common-voice` code base via pull requests
* Developers who would like to self-host `common-voice` on their own infrastructure, or re-purpose it to their own needs. _NOTE:_ unfortunately due to resourcing constraints, we are unable to assist you in self-hosting outside of a commercial support arrangement, beyond what is given in this document. Please [make contact](mailto:commonvoice@mozilla.com?Subject=Inquiry about commercial hosting arrangements for Common Voice) if you would like further information regarding a commercial arrangement.  

## Prerequistes 

* `git` is installed on your local computer. [More information on installing `git`](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git).
* You are familiar with common `git` commands like `git commit` and `git push`. 
* `docker` is installed on your local computer. [More information on installing `docker`](https://docs.docker.com/engine/install/).
* [`docker compose`](https://docs.docker.com/compose/) is installed on your system.
* You are comfortable running Docker processes, either through the command line or through Docker desktop.

## Summary to get up and running 

* Fork and clone the repo 
* Set up an Auth0 tenant or similar to provide authentication.
* Copy the `.env-local-docker.example` file to `.env-local-docker`, and edit as required for your context
* Run `docker` containers with `docker compose up`
* Flush `redis` cache when sentences from your language are imported 
* Restart `docker` containers
* Visit [http://localhost:9000](http://localhost:9000).

## Forking and cloning the `common-voice` repository

1. [Fork](https://github.com/common-voice/common-voice/fork) the `common-voice` repository into your own GitHub account. For help with forking, [refer to the GitHub documentation](https://help.github.com/articles/fork-a-repo/).

2. Clone the `common-voice` repository onto your local computer. You will need to have `git` installed first. 

```sh
git clone https://github.com/common-voice/common-voice
```
For help with cloning, [refer to the GitHub documentation](https://help.github.com/articles/cloning-a-repository/). 

_NOTE_: The `spontaneous-speech` components of Common Voice are not open source and are not available in this repository.

## Project organization

The project is organized into the following directories:

- _common_: Features that are shared between the frontend and backend of Common Voice, such as Typescript types.
- _locales_: Information about activated languages on the site, automatically generated by [yarn import-locales](#updating-languages)
- _maintenance_: Static code for maintenance mode on Common Voice
- _scripts_: Some scripts for managing data
- _server_: The server-side app logic, written in [TypeScript](http://www.typescriptlang.org/).
- _web_: The Common Voice website files, written in [TypeScript](http://www.typescriptlang.org/). We use [React](https://reactjs.org/) to build the website.
- _bundler_: Service that is creating the dataset release bundles for Common Voice, written in [TypeScript](http://www.typescriptlang.org/).

## Orchestrating the environment with `docker` and `docker-compose`

_NOTE: If you are working on a branch from your local fork of `common-voice` and subsequently raise a PR on the `common-voice` project, and this PR resolves an Issue in the `common-voice` repo, please ensure that the [Issue is mentioned in the PR or otherwise linked](https://docs.github.com/en/issues/tracking-your-work-with-issues/using-issues/linking-a-pull-request-to-an-issue) for traceability. Linking Issues and PRs helps us to review them more efficiently._

Common Voice uses Docker and Docker Compose for orchestrating the development environment. While it is possible to install each component separately, we neither encourage nor support this.

### `.env-local-docker` file

`docker-compose` uses a configuration file - [`docker-compose.yaml`](../docker-compose.yaml) in order to build and launch `docker` containers. This file passes information such as the name of the containers,  the users they should be run as, and networking configuration information, to `docker`. 

It works hand in hand with a set of environment variables that are held in the `.env-local-docker` file. The `common-voice` repo contains an [example `.env-local-docker` file](../.env-local-docker.example). Each variable is prefixed with `CV_` so that it doesn't clash with any other `docker`-based applications running on your system.

3. Copy the example file `.env-local-docker.example` to `.env-local-docker`

```sh
> cd common-voice
> cp .env-local-docker.example .env-local-docker
```

The environment variables held in this file are explained below:

```Dotenv
CV_DB_ROOT_PASS="voicewebroot"
CV_MYSQLHOST="db"
```

These variables specify the MySQL root password and the name of the Docker container which provides the database service. In general, these should not need to be modified. 

```Dotenv
CV_STORAGE_LOCAL_DEVELOPMENT_ENDPOINT="http://storage:8080"
CV_BULK_SUBMISSION_BUCKET_NAME="common-voice-bulk-submissions"
CV_ENVIRONMENT="local"
CV_PROD="false"
```

```Dotenv
CV_IMPORT_SENTENCES="true"
CV_IMPORT_LANGUAGES="en,de,tr"
```

These vars specify which sentences to import when the Docker containers are run. You should set `CV_IMPORT_SENTENCES` to "true" if you are testing a particular language, and then specify its language code in `CV_IMPORT_LANGUAGES`. This will instruct the application to import the sentences located in `server/data/*` on start up. This step is _IMPORTANT_ to be able to contribute to specific languages. Sentences are imported alphabetically by language code, so Arabic (`ar`) is imported before English (`en`), which is imported before Kiswahili (`sw`). Note that importing sentences for _all_ languages will take several hours, so be sure to specify only the language(s) you need. 

```Dotenv
CV_EMAIL_USERNAME_FROM="commonvoice@mozilla.com"
CV_EMAIL_USERNAME_TO="commonvoice@mozilla.com"
```

If you are self-hosting Common Voice, you should change this to your email address. 

```Dotenv
CV_REDIS_URL="redis"
```

This specifies the caching docker container to use. You should only need to change this if you replace Redis with another caching layer

```Dotenv
CV_JWT_KEY=super-secure-key
```

This is used for JWT authentication. You don't need to change it


### Running the application through `docker`

4. Once you have cloned and forked the repo, copied the `.env-local-docker.example` file, then run the following commands:

```sh
> cd common-voice
> docker-compose up
```

This is going to:

- Launch a `mysql` instance configured for `common-voice`
- Launch a fake GCP Cloud Storage instance to store files locally and avoid going through setting up GCP Cloud Storage
- Mount the project using a Docker volume to allow reflecting changes to the codebase directly to the container
- Import sentences from `server/data/*` if the key `CV_IMPORT_SENTENCES` is true
- Launch `common-voice` server
- Launch `bundler` service

#### Flushing the `redis` cache

Once you've imported the sentences for all locales specified in `CV_IMPORT_LANGUAGES`, open a new terminal and flush the `redis` cache:

```sh
> docker exec -it redis redis-cli FLUSHALL
```

This will ensure that on the next restart the languages, that we just imported sentences for, will be available for contribution.

Then, restart the server by stopping the containers (Ctrl+C on the command line) and then using `docker compose up` again. 

You should be able to visit the Common Voice web server at [http://localhost:9000](http://localhost:9000).

### Minimal setup

The _bundler_ service is not strictly needed to run the common voice website. Run the following commands to just run the minimal setup:

```sh
> cd common-voice
> docker-compose up web
```

Docker can be a very memory-intensive process. If you notice intermittent failures, or if features like auto-rebuilding crash, try increasing Docker's available memory from within Docker's _Preferences > Resources_ settings.

## Troubleshooting

### Couldn't connect to Docker daemon 

If you get an error like the following when running native Docker (not Docker for Desktop),

```sh
ERROR: Couldn't connect to Docker daemon at http+docker://localhost - is it running?
```

You may need to build a new Docker image. You can do that by issuing the following commands:

```sh
> cd docker/
> docker build .
```

Then after this you can:

```sh
> cd ..
> docker compose up
```

You may have to run these commands as root/superuser.

### Running `docker-compose up` results in incorrect file system permissions on `/code/node_modules` directory 

After running `docker-compose up`, on Ubuntu, Fedora or other Linux-based systems, you may observe that the directory `/code/node_modules` is owned by `root:root` instead of `app:app`. 

You may also observe the errors:  

* `error Error: EACCES: permission denied, unlink '/code/node_modules/.yarn-integrity'` 
* `EACCES permission denied mkdir /code/node_modules`

when the `web` container is building. 

The root cause of this error is [this line](https://github.com/common-voice/common-voice/blob/bc8d0c501a51c735b907ad6e99368b2a47b3f15e/docker-compose.yaml#L62) in the `docker-compose.yaml`, which is intended to set the `GID` and `UID` to a non-root user. 

`user: '${UID:-1000}:${GID:-1000}'`

(These settings also appear under the `bundler` config. The `bundler` is only used for dataset releases, so we're only concerned about the `web` config here.)

However, in some cases, the `UID` and `GID` of your system may not be `1000:1000`, which causes the error. 

The workaround is to first identify the `UID` and `GID` of the current user, then edit the line in `docker-compose.yaml` to have that `UID` and `GID`:

```sh
> id -u
2000

> id -g
2000
```

(in `docker-compose.yaml`)

`user: '${UID:-2000}:${GID:-2000}'`

You should then be able to run `docker-compose up` successfully. 

## Linting Typescript code contributions

We're using ESLint (with Typescript) and Prettier to lint the project.

Install ESlint and Prettier extentions into your code editor or you can run this for all files with:

```bash
yarn lint
```

> For now this is not automatically checked on Pull Requests or blocking while we fix existing issues.

## Authentication

If you want to work with login-related features (Profile, Dashboard, Goals, ...) you'll need to set up authentication:

1. Create an [Auth0](https://auth0.com/) account.
2. Click "Applications" from the dashboard. Create a new one, or use the default application.
3. On "Applications" still, next to your application, click the "three dots" icon, then Settings.
4. Add `http://localhost:9000/callback` to the "Allowed Callback URLs" list.
5. Copy the Auth0 application settings into your configuration file. These are found in the same Settings tab as the "Allowed Callback URLs".

For Docker, in `.env-local-docker`:

```Dotenv
CV_FXA_DOMAIN="<domain_here>"
CV_FXA_CLIENT_ID="<client_id_here>"
CV_FXA_CLIENT_SECRET="<client_secret_here>"
```

6. You can add more login options to your app from the "Connections" tab
7. Restart your local Common Voice instance
8. You will now be able to create a new user by clicking on "Log in" on your Common Voice instance and then switching over to the "Sign Up" tab on the login dialog.

## Database migrations

We use [db-migrate](https://github.com/db-migrate/node-db-migrate) for running database migrations.

To add a migration run:
`yarn migrate:local create <MIGRATION_NAME>`.

At the moment you manually have to change the migration file extension to `.ts`. A migration has to expose the following API:

```ts
export const up = async function (db: any): Promise<any> {
  return null
}

export const down = async function (): Promise<any> {
  return null
}
```

Migrations are always run when the server is started.

To migrate up or down manually run:
`yarn migrate:local [up|down]`.

This will execute the most recently added migration in the migrations folder.

## Localization

We're using [Fluent](http://projectfluent.org/) to localize strings. You can find examples all over the frontend code. Strings that appear in the [english message files](https://github.com/mozilla/common-voice/tree/main/web/locales/common-voice), can then be translated on [Pontoon](https://pontoon.mozilla.org/projects/common-voice/en). Some things to note regarding string changes are documented on [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Localization/Localization_content_best_practices#Changing_existing_strings).

## Testing using Jest 

We write unit tests using [Jest](https://jestjs.io/). Test files should be named `function_or_service.test.ts` where `function_or_service.ts` is the name of the Typescript file. 

To run a unit test, or _all_ unit tests in the application, first enter the Docker container and open a bash shell, then run `yarn test`:

```sh
docker exec -it common-voice bash
$ yarn test
```

To run a single unit test, run `yarn [path to test file]`.

## Submitting an Issue

Did you notice a bug? Do you have a feature request? Please file an issue [here on GitHub](https://github.com/mozilla/common-voice/issues).

## Something Else?

Want to talk about something but can't find a home for it here? Head to our [Discourse Category](https://discourse.mozilla-community.org/c/voice) to discuss everything from feedback and ideas to questions and random musings.
