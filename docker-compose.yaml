version: '3'
services:
  db:
    image: mariadb:10.4
    # networks:
    #   - falak-network
    container_name: voicewall-db1
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=voiceweb
      - MYSQL_USER=voicecommons
      - MYSQL_PASSWORD=voicecommons
      - MYSQL_ROOT_PASSWORD=voicewebroot
    ports:
      - 127.0.0.1:3306:3306
    volumes:
      - ../falak-host/voicewall-db:/var/lib/mysql:Z
      - ../falak-host:/host
  adminer:
    image: adminer
    container_name: voicewall-adminer
    restart: always
    ports:
      - 8010:8080
    networks:
      - falak-network
  redis:
    image: redis:alpine
    container_name: voicewall-redis1
    restart: unless-stopped
    ports:
      - 127.0.0.1:6379:6379
    # networks:
    #   - falak-network
  storage:
    image: fsouza/fake-gcs-server
    container_name: voicewall-storage
    ports:
      - 8080:8080
      - 4443:4443
    volumes:
      - ../falak-host/voicewall-storage:/data
    networks:
      - falak-network
    command: [ '-scheme', 'http', '-port', '8080', '-external-url', 'http://storage:8080', '-backend', 'filesystem' ]
  bundler:
    build:
      context: ./bundler
      dockerfile: Dockerfile
    container_name: bundler
    links:
      - db
      - redis
      - storage
    volumes:
      - ./bundler:/home/node/code
    networks:
      - falak-network
    ports:
      - 9001:9001
    command: bash -c "npm ci && npm run build && npm start"
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: voicewall-web
    links:
      - db
      - redis
      - storage
    volumes:
      - .:/code:Z
    environment:
      - DOTENV_CONFIG_PATH=/code/.env-local-docker
    networks:
      - falak-network
    ports:
      - 9090:9090
  web-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile-dev
    container_name: voicewall-web-dev
    volumes:
      - ../falak-host:/host
      - .:/app:Z
      - /app/node_modules # Prevent overwriting node_modules in the container
    env_file:
      - ../falak.env
    environment:
      - DOTENV_CONFIG_PATH=/code/.env-local-docker
      - CHOKIDAR_USEPOLLING=true # Ensure changes are detected in mounted volumes
    ports:
      - 9091:9090
  
networks:
  falak-network:
    external: true
