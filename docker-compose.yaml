version: '3'
services:
  db:
    image: mariadb:10.4
    networks:
      - falak-network
    container_name: voicewall-db
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=voiceweb
      - MYSQL_USER=voicecommons
      - MYSQL_PASSWORD=voicecommons
      - MYSQL_ROOT_PASSWORD=voicewebroot
    ports:
      - 127.0.0.1:3307:3306
    volumes:
      - ../falak-host/voicewall-db:/var/lib/mysql:Z
      - ../falak-host:/host
  adminer:
    image: adminer
    container_name: voicewall-adminer
    restart: always
    ports:
      - 8010:8080
    networks:
      - falak-network
  redis:
    image: redis:alpine
    container_name: voicewall-redis
    restart: unless-stopped
    ports:
      - 127.0.0.1:6379:6379
    networks:
      - falak-network
  storage:
    image: fsouza/fake-gcs-server
    container_name: voicewall-storage
    ports:
      - 8080:8080
      - 4443:4443
    volumes:
      - ../falak-host/voicewall-storage:/data
    networks:
      - falak-network
    command: [ '-scheme', 'http', '-port', '8080', '-external-url', 'http://storage:8080', '-backend', 'filesystem' ]
  bundler:
    build:
      context: ./bundler
      dockerfile: Dockerfile
    container_name: bundler
    links:
      - db
      - redis
      - storage
    volumes:
      - ./bundler:/home/node/code
    networks:
      - falak-network
    ports:
      - 9001:9001
    command: bash -c "npm ci && npm run build && npm start"
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: voicewall-web
    links:
      - db
      - redis
      - storage
    volumes:
      - .:/code:Z
    environment:
      - DOTENV_CONFIG_PATH=/code/.env-local-docker
    networks:
      - falak-network
    ports:
      - 9090:9090
    command: bash -c "/code/docker/wait-for-it.sh storage:8080 -- /code/docker/prepare_storage.sh && yarn && yarn start"

networks:
  falak-network:
    external: true
